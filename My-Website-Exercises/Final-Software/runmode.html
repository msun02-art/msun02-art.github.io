<!DOCTYPE html>
<html lang="en">
  <head>
    <title>FUNRUN – Runmode (Random Route)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Carlito:wght@400;700&display=swap"
    />
    <link rel="stylesheet" href="globals.css" />
    <link rel="stylesheet" href="runmode.css" />
  </head>

  <body>
    <div class="wrapper-main">
      <div class="iphone-pro">
        <header class="top-bar">
          <div class="user-info">
            <div class="avatar-circle"></div>
            <span class="username">Username</span>
          </div>
        </header>

        <div class="top-divider"></div>
        <div class="gpsroute-area">
          <div id="gps-status" class="gps-status">
            Tap START to generate a route.
          </div>

          <div class="gps-canvas-wrapper">
            <canvas id="routeCanvas"></canvas>
          </div>
        </div>

        <div class="run-buttons">
          <button class="start-btn" id="start-btn">START</button>

          <div class="run-controls" id="run-controls">
            <button class="control-btn pause-btn" id="pause-btn">Pause</button>
            <button class="control-btn end-btn" id="end-btn">End</button>
          </div>
        </div>

      
        <nav class="bottom-nav">
          <button
            class="nav-item nav-home"
            onclick="window.location.href='homepage.html'"
          >
            Home
          </button>
          <button
            class="nav-item nav-run"
            onclick="window.location.href='runmode.html'"
          >
            Run
          </button>
          <button
            class="nav-item nav-gallery"
            onclick="window.location.href='gallery.html'"
          >
            Gallery
          </button>
        </nav>
      </div>
    </div>

    <script>
      const canvas = document.getElementById("routeCanvas");
      const ctx = canvas.getContext("2d");
      const statusEl = document.getElementById("gps-status");

      let pathPoints = [];
      let running = false;
      let stopped = false;

      let x = 0;
      let y = 0;
      let angle = 0;
      const STEP = 1;
      let stepsCount = 0;
      const MAX_STEPS = 800;
      let animationId = null;

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function resizeCanvas() {
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        redrawPath();
      }

      window.addEventListener("resize", resizeCanvas);

      function redrawPath() {
        ctx.fillStyle = "#88c4ff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (pathPoints.length === 0) return;

        ctx.lineWidth = 4;
        ctx.lineJoin = "round";
        ctx.lineCap = "round";
        ctx.strokeStyle = "#283593";
        ctx.shadowColor = "rgba(40,53,147,0.3)";
        ctx.shadowBlur = 2;

        ctx.beginPath();
        pathPoints.forEach((p, i) => {
          if (i === 0) ctx.moveTo(p.x, p.y);
          else ctx.lineTo(p.x, p.y);
        });
        ctx.stroke();

        ctx.shadowBlur = 0;

        const start = pathPoints[0];
        ctx.fillStyle = "#F4FF75";
        ctx.beginPath();
        ctx.arc(start.x, start.y, 7, 0, Math.PI * 2);
        ctx.fill();

        const last = pathPoints[pathPoints.length - 1];
        ctx.fillStyle = "#ff7043";
        ctx.beginPath();
        ctx.arc(last.x, last.y, 5, 0, Math.PI * 2);
        ctx.fill();
      }

      function stepRoute() {
        if (!running || stopped) {
          animationId = null;
          return;
        }

        const margin = 20;

        angle += (Math.random() - 0.5) * 0.5;

        let newX = x + Math.cos(angle) * STEP;
        let newY = y + Math.sin(angle) * STEP;

        if (
          newX < margin ||
          newX > canvas.width - margin ||
          newY < margin ||
          newY > canvas.height - margin
        ) {
          angle += Math.PI / 2;
          newX = x + Math.cos(angle) * STEP;
          newY = y + Math.sin(angle) * STEP;
        }

        x = newX;
        y = newY;
        pathPoints.push({ x, y });
        stepsCount++;

        setStatus("Drawing route… steps: " + stepsCount);

        redrawPath();

        if (stepsCount >= MAX_STEPS) {
          setStatus(
            "Route complete.\nTap End to continue or Pause to stop viewing."
          );
          running = false;
          animationId = null;
          return;
        }

        animationId = requestAnimationFrame(stepRoute);
      }

      function onStartClick() {
        stopped = false;
        running = true;
        pathPoints = [];
        stepsCount = 0;

        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;

        x = canvas.width / 2;
        y = canvas.height / 2;
        angle = Math.random() * Math.PI * 2;

        pathPoints.push({ x, y });
        redrawPath();

        setStatus("Drawing your route…");

        if (!animationId) {
          animationId = requestAnimationFrame(stepRoute);
        }
      }

      function onPauseClick(btn) {
        if (!running) {
          running = true;
          setStatus("Resumed. Drawing continues…");
          btn.textContent = "Pause";
          if (!animationId) {
            animationId = requestAnimationFrame(stepRoute);
          }
        } else {
          running = false;
          setStatus("Paused.");
          btn.textContent = "Resume";
        }
      }

      function onEndClick() {
        const ok = confirm("Finish this run?");
        if (!ok) return;

        running = false;
        stopped = true;
        if (animationId) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }

        setStatus("Stopped. Steps: " + stepsCount);

        try {
          const dataURL = canvas.toDataURL("image/png");
          localStorage.setItem("funrunRouteImage", dataURL);
        } catch (e) {
          console.log("Failed to save route image:", e);
        }

        window.location.href = "pixel.html";
      }

      window.addEventListener("load", () => {
        resizeCanvas();

        const startBtn = document.getElementById("start-btn");
        const controls = document.getElementById("run-controls");
        const pauseBtn = document.getElementById("pause-btn");
        const endBtn = document.getElementById("end-btn");

        controls.style.display = "none";
        startBtn.style.display = "block";

        startBtn.addEventListener("click", () => {
          onStartClick();
          startBtn.style.display = "none";
          controls.style.display = "flex";
        });

        pauseBtn.addEventListener("click", () => {
          onPauseClick(pauseBtn);
        });

        endBtn.addEventListener("click", () => {
          onEndClick();
        });
      });
    </script>
  </body>
</html>