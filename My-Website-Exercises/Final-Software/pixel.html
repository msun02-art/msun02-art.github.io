<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>FUNRUN â€“ Pixel Art</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Carlito:wght@400;700&display=swap"
    />
    <link rel="stylesheet" href="globals.css" />
    <link rel="stylesheet" href="stylerun8.css" />

    <style>
      body {
        margin: 0;
        font-family: "Carlito", sans-serif;
        background: #e0e0e0;
      }

      .wrapper-main {
        width: 100%;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 40px 0;
      }

      .iphone-pro.pixel-page {
        background: #ffffff;
        width: 100%;
        max-width: 402px;
        min-height: 874px;
        position: relative;
        padding: 40px 24px 120px;
        box-sizing: border-box;
        overflow-y: auto;
      }

      .pixel-title {
        text-align: center;
        font-size: 22px;
        color: #57a368;
        margin-bottom: 20px;
      }

      .pixel-canvas-wrap {
        width: 100%;
        height: 340px;
        background: #ffffff;
        border-radius: 18px;
        overflow: hidden;
        border: none;
        padding: 0;
      }

      #pixelCanvas {
        width: 100%;
        height: 100%;
        display: block;
      }

      .pixel-controls {
        margin-top: 14px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .pixel-size-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        font-size: 14px;
        margin-left: 24px;
        color: #57a368;
      }

      .pixel-size-label {
        width: 120px;
        flex-shrink: 0;
      }

      .pixel-size-slider-wrap {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .pixel-size-slider-wrap input[type="range"] {
        flex: 1;
        max-width: 140px;
      }

      .pixel-size-value {
        font-size: 13px;
        color: #57a368;
        white-space: nowrap;
      }

      .mood-title {
        margin-top: 20px; 
        font-size: 14px;
        font-weight: 700;
        color: #57a368;
        margin-left: 24px;
      }

      .slider-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 4px;
        font-size: 13px;
      }

      .slider-row span {
        width: 120px;
        flex-shrink: 0;
        color: #57a368;
        margin-left: 24px;
      }

      .slider-row input[type="range"] {
        flex: 1;
      }

      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        height: 4px;
        border-radius: 2px;
        background: #57a36855;
        outline: none;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #57a368;
        cursor: pointer;
        border: none;
      }

      input[type="range"]::-moz-range-track {
        height: 4px;
        border-radius: 2px;
        background: #57a36855;
      }

      input[type="range"]::-moz-range-thumb {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #57a368;
        cursor: pointer;
        border: none;
      }


      .save-btn {
        margin-top: 12px;
        padding: 8px 16px;
        border: none;
        border-radius: 20px;
        background: #f4ff75;
        color: #57a368;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        align-self: flex-end;
      }

      .save-btn:hover {
        filter: brightness(0.95);
      }


      .bottom-nav {
        position: absolute;
        left: 0;
        bottom: 0;
        height: 100px;
        width: 100%;
        background-color: #f4ff75;

        display: flex;
        align-items: center;
        justify-content: stretch;
        padding: 0;
      }

      .nav-item {
        flex: 1;
        height: 100%;
        background: none;
        border: none;
        cursor: pointer;

        font-size: 18px;
        font-weight: 600;
        color: #57a368;

        display: flex;
        align-items: center;
        justify-content: center;
      }

      .nav-item:active {
        opacity: 0.7;
      }

      .nav-item.active {
        background-color: transparent; 
        box-shadow: none;
      }
    </style>
  </head>

  <body>
    <div class="wrapper-main">
      <div class="iphone-pro pixel-page">
        <h1 class="pixel-title">Generate Art</h1>

   
        <div class="pixel-canvas-wrap">
          <canvas id="pixelCanvas"></canvas>
        </div>

  
        <div class="pixel-controls">
          <div class="pixel-size-row">
            <span class="pixel-size-label">Pixel size</span>
            <div class="pixel-size-slider-wrap">
              <input
                type="range"
                id="pixelSize"
                min="4"
                max="40"
                value="12"
              />
              <span class="pixel-size-value">
                <span id="pixelSizeValue">12</span> px
              </span>
            </div>
          </div>

          <div class="mood-title">Mood after this run :</div>

          <div class="slider-row">
            <span>Happy</span>
            <input id="mood-happy" type="range" min="0" max="100" value="60" />
          </div>

          <div class="slider-row">
            <span>Accomplished</span>
            <input
              id="mood-accomplished"
              type="range"
              min="0"
              max="100"
              value="50"
            />
          </div>

          <div class="slider-row">
            <span>Relieved</span>
            <input
              id="mood-relieved"
              type="range"
              min="0"
              max="100"
              value="40"
            />
          </div>

          <div class="slider-row">
            <span>Energetic</span>
            <input
              id="mood-energetic"
              type="range"
              min="0"
              max="100"
              value="50"
            />
          </div>

          <div class="slider-row">
            <span>Refreshed</span>
            <input
              id="mood-refreshed"
              type="range"
              min="0"
              max="100"
              value="40"
            />
          </div>

          <div class="slider-row">
            <span>Calm</span>
            <input
              id="mood-calm"
              type="range"
              min="0"
              max="100"
              value="35"
            />
          </div>

          <div class="slider-row">
            <span>Clear-headed</span>
            <input
              id="mood-clearHeaded"
              type="range"
              min="0"
              max="100"
              value="30"
            />
          </div>

          <div class="slider-row">
            <span>Exhausted</span>
            <input
              id="mood-exhausted"
              type="range"
              min="0"
              max="100"
              value="20"
            />
          </div>

          <div class="slider-row">
            <span>Sore</span>
            <input
              id="mood-sore"
              type="range"
              min="0"
              max="100"
              value="15"
            />
          </div>

          <div class="slider-row">
            <span>Aching</span>
            <input
              id="mood-aching"
              type="range"
              min="0"
              max="100"
              value="10"
            />
          </div>

          <div class="slider-row">
            <span>Irritable</span>
            <input
              id="mood-irritable"
              type="range"
              min="0"
              max="100"
              value="5"
            />
          </div>

    
          <button class="save-btn" id="saveBtn">
            save art
          </button>
        </div>

     
        <nav class="bottom-nav">
          <button
            class="nav-item nav-home"
            onclick="window.location.href='homepage.html'"
          >
            Home
          </button>

          <button
            class="nav-item nav-run"
            onclick="window.location.href='runmode.html'"
          >
            Run
          </button>

          <button
            class="nav-item nav-gallery"
            onclick="window.location.href='gallery.html'"
          >
            Gallery
          </button>
        </nav>
      </div>
    </div>

    <script>
      const dataURL = localStorage.getItem("funrunRouteImage");
      const canvas = document.getElementById("pixelCanvas");
      const ctx = canvas.getContext("2d");

      const pixelSizeSlider = document.getElementById("pixelSize");
      const pixelSizeValue = document.getElementById("pixelSizeValue");
      const saveBtn = document.getElementById("saveBtn");

      const STORAGE_KEY = "funrunGalleryItems";

      const img = new Image();

      
      const BACK_BG = { r: 224, g: 255, b: 254 };
      const ROUTE_BG_COLOR = { r: 136, g: 196, b: 255 };

      const moods = {
        happy: { color: "#FFE66D" },
        accomplished: { color: "#C8FF7A" },
        relieved: { color: "#A4F3D5" },
        energetic: { color: "#FFB347" },
        refreshed: { color: "#7BE0AD" },
        calm: { color: "#7BC4FF" },
        clearHeaded: { color: "#D6E4FF" },
        exhausted: { color: "#6B7A8F" },
        sore: { color: "#C27BA0" },
        aching: { color: "#A35D6A" },
        irritable: { color: "#FF6B6B" },
      };

      function getMoodWeights() {
        const weights = {};
        let total = 0;

        for (const key of Object.keys(moods)) {
          const slider = document.getElementById("mood-" + key);
          const value = slider ? Number(slider.value) : 0;
          weights[key] = value;
          total += value;
        }

        if (total === 0) {
          const n = Object.keys(moods).length;
          for (const key of Object.keys(moods)) {
            weights[key] = 1;
          }
          total = n;
        }

        return { weights, total };
      }

      function pickColorByMood() {
        const { weights, total } = getMoodWeights();
        let r = Math.random() * total;

        for (const key of Object.keys(moods)) {
          r -= weights[key];
          if (r <= 0) {
            return moods[key].color;
          }
        }
        return moods.happy.color;
      }

     
      function isRoutePixel(r, g, b, a) {
        if (a < 20) return false; 

        const dr = r - ROUTE_BG_COLOR.r;
        const dg = g - ROUTE_BG_COLOR.g;
        const db = b - ROUTE_BG_COLOR.b;
        const distSq = dr * dr + dg * dg + db * db;
        return distSq > 30 * 30;
      }

     
      function backgroundPixelColor(x, y) {
        const t = Math.sin(x * 12.9898 + y * 78.233) * 43758.5453;
        const rand = t - Math.floor(t); 

        const delta = Math.round((rand - 0.5) * 16); 

        const r = Math.max(0, Math.min(255, BACK_BG.r + delta));
        const g = Math.max(0, Math.min(255, BACK_BG.g + delta));
        const b = Math.max(0, Math.min(255, BACK_BG.b + delta));

        return `rgb(${r},${g},${b})`;
      }

      function blendWithBackground(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);

        const br = BACK_BG.r;
        const bg = BACK_BG.g;
        const bb = BACK_BG.b;

        const nr = Math.round(r * alpha + br * (1 - alpha));
        const ng = Math.round(g * alpha + bg * (1 - alpha));
        const nb = Math.round(b * alpha + bb * (1 - alpha));

        return `rgb(${nr},${ng},${nb})`;
      }

      if (!dataURL) {
        canvas.width = 300;
        canvas.height = 200;
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#57a368";
        ctx.font = "16px Carlito";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(
          "No route yet. Run first!",
          canvas.width / 2,
          canvas.height / 2
        );
      } else {
        img.src = dataURL;
        img.onload = () => {
          drawPixelArt();
        };
      }

      function drawPixelArt() {
        if (!img.width || !img.height) return;

        const pixelSize = parseInt(pixelSizeSlider.value, 10);
        pixelSizeValue.textContent = pixelSize;

        const wrap = canvas.parentElement;
        const w = wrap.clientWidth;
        const h = wrap.clientHeight;

        canvas.width = w;
        canvas.height = h;

        const smallW = Math.max(1, Math.floor(w / pixelSize));
        const smallH = Math.max(1, Math.floor(h / pixelSize));

        const off = document.createElement("canvas");
        off.width = smallW;
        off.height = smallH;
        const offCtx = off.getContext("2d");

        offCtx.drawImage(img, 0, 0, smallW, smallH);
        const imgData = offCtx.getImageData(0, 0, smallW, smallH).data;

        const routeMask = new Array(smallW * smallH).fill(false);
        for (let y = 0; y < smallH; y++) {
          for (let x = 0; x < smallW; x++) {
            const idx = (y * smallW + x) * 4;
            const r = imgData[idx];
            const g = imgData[idx + 1];
            const b = imgData[idx + 2];
            const a = imgData[idx + 3];

            routeMask[y * smallW + x] = isRoutePixel(r, g, b, a);
          }
        }

      
        const thickness = 1;
        function hasRouteNeighbor(x, y) {
          for (let dy = -thickness; dy <= thickness; dy++) {
            for (let dx = -thickness; dx <= thickness; dx++) {
              const nx = x + dx;
              const ny = y + dy;
              if (nx < 0 || nx >= smallW || ny < 0 || ny >= smallH) continue;
              if (routeMask[ny * smallW + nx]) return true;
            }
          }
          return false;
        }

        ctx.clearRect(0, 0, w, h);

        for (let y = 0; y < smallH; y++) {
          for (let x = 0; x < smallW; x++) {
            const i = y * smallW + x;
            let color;

            if (routeMask[i]) {
              const moodColor = pickColorByMood();
              color = moodColor;
            } else if (hasRouteNeighbor(x, y)) {
              const moodColor = pickColorByMood();
              color = blendWithBackground(moodColor, 0.45);
            } else {
              color = backgroundPixelColor(x, y);
            }

            ctx.fillStyle = color;
            ctx.fillRect(
              x * pixelSize,
              y * pixelSize,
              pixelSize,
              pixelSize
            );
          }
        }
      }

      pixelSizeSlider.addEventListener("input", () => {
        if (img.complete && img.src) {
          drawPixelArt();
        }
      });

      for (const key of Object.keys(moods)) {
        const slider = document.getElementById("mood-" + key);
        slider.addEventListener("input", () => {
          if (img.complete && img.src) {
            drawPixelArt();
          }
        });
      }

      window.addEventListener("resize", () => {
        if (img.complete && img.src) {
          drawPixelArt();
        }
      });

      function saveArtToGallery() {
        if (!canvas.width || !canvas.height) return;

        if (img.complete && img.src) {
          drawPixelArt();
        }

        try {
          const dataUrl = canvas.toDataURL("image/png");

          const raw = localStorage.getItem(STORAGE_KEY);
          const items = raw ? JSON.parse(raw) : [];

          items.push({
            id: Date.now(),
            dataUrl: dataUrl,
          });

          localStorage.setItem(STORAGE_KEY, JSON.stringify(items));

          alert("Saved to Gallery!");
        } catch (e) {
          console.error("Save to gallery failed", e);
          alert("Failed to save. Please try again.");
        }
      }

      saveBtn.addEventListener("click", saveArtToGallery);
    </script>
  </body>
</html>